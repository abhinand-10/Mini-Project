<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Prediction - Tax-Vision</title>
    <script src="https://kit.fontawesome.com/4a148a2491.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .save-section {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            background-color: #f9fafb;
        }
        .save-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .save-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .save-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .login-prompt {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            margin-top: 1rem;
        }
        .prediction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/" class="flex items-center text-blue-600 font-bold text-lg rounded-full px-3 py-1 bg-blue-100 transition-transform transform hover:scale-105">
                <i class="fas fa-chart-line mr-2"></i>
                <span>Tax-Vision</span>
            </a>
            <div class="flex space-x-4 items-center">
                <a href="/gst" class="text-gray-600 hover:text-blue-600 transition-colors">GST Fraud</a>
                <a href="/tds" class="text-gray-600 hover:text-blue-600 transition-colors">TDS Fraud</a>
                <a href="/income_tax" class="text-gray-600 hover:text-blue-600 transition-colors">Income Tax</a>
                <a href="/tax_prediction" class="text-blue-600 font-bold border-b-2 border-blue-600">Tax Prediction</a>
                {% if session.user_id %}
                    <a href="/dashboard" class="text-blue-600 font-medium flex items-center">
                        <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
                    </a>
                    <span class="text-gray-600">Hello, {{ session.username }}</span>
                    <a href="/logout" class="text-gray-600 hover:text-blue-600 transition-colors">Logout</a>
                {% else %}
                    <a href="/login" class="text-gray-600 hover:text-blue-600 transition-colors">Login</a>
                    <a href="/signup" class="bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-blue-700 transition-colors">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 border border-gray-200">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">AI Tax Prediction</h2>
                <p class="text-gray-500 text-sm md:text-base">
                    Enter your past 2 years financial data to predict future tax liability using machine learning
                </p>
            </div>

            <!-- Tax Prediction Section -->
            <div id="taxPredictSection" class="space-y-6">
                <form id="taxPredictForm" class="space-y-6">
                    <!-- Past 2 Years Data -->
                    <div class="border-b pb-6 border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-history mr-2 text-blue-600"></i>
                            Past 2 Years Financial Data
                        </h3>
                        
                        <!-- Year 1 Data -->
                        <div class="mb-6">
                            <h4 class="text-lg font-medium text-gray-700 mb-3">Year 1 Data (Previous Year)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="past_income_year_1" class="block text-sm font-medium text-gray-700">Annual Income (₹)</label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500">₹</span>
                                        </div>
                                        <input type="number" id="past_income_year_1" name="past_income_year_1" required
                                               class="block w-full pl-7 pr-4 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500 bg-gray-50"
                                               placeholder="e.g., 650000" min="0" step="1000">
                                    </div>
                                </div>
                                <div>
                                    <label for="past_tax_year_1" class="block text-sm font-medium text-gray-700">Tax Paid (₹)</label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500">₹</span>
                                        </div>
                                        <input type="number" id="past_tax_year_1" name="past_tax_year_1" required
                                               class="block w-full pl-7 pr-4 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500 bg-gray-50"
                                               placeholder="e.g., 45000" min="0" step="1000">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Year 2 Data -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-700 mb-3">Year 2 Data (Current Year)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="past_income_year_2" class="block text-sm font-medium text-gray-700">Annual Income (₹)</label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500">₹</span>
                                        </div>
                                        <input type="number" id="past_income_year_2" name="past_income_year_2" required
                                               class="block w-full pl-7 pr-4 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500 bg-gray-50"
                                               placeholder="e.g., 750000" min="0" step="1000">
                                    </div>
                                </div>
                                <div>
                                    <label for="past_tax_year_2" class="block text-sm font-medium text-gray-700">Expected Tax (₹)</label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500">₹</span>
                                        </div>
                                        <input type="number" id="past_tax_year_2" name="past_tax_year_2" required
                                               class="block w-full pl-7 pr-4 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500 bg-gray-50"
                                               placeholder="e.g., 55000" min="0" step="1000">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Input -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-crystal-ball mr-2 text-purple-600"></i>
                            Prediction Parameters
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="current_income" class="block text-sm font-medium text-gray-700">Expected Future Income (₹)</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500">₹</span>
                                    </div>
                                    <input type="number" id="current_income" name="current_income" required
                                           class="block w-full pl-7 pr-4 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500 bg-gray-50"
                                           placeholder="e.g., 850000" min="0" step="1000">
                                </div>
                            </div>
                            <div>
                                <label for="prediction_year" class="block text-sm font-medium text-gray-700">Year for Prediction</label>
                                <input type="number" id="prediction_year" name="prediction_year" required
                                       class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-50 p-2"
                                       placeholder="e.g., 2025" min="2024" max="2030">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center pt-4">
                        <button type="submit" id="predictBtn"
                                class="bg-blue-600 text-white px-8 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-colors font-semibold flex items-center transform hover:scale-105">
                            <i class="fas fa-brain mr-2"></i>
                            <span id="buttonText">Predict Future Tax</span>
                            <i id="loadingSpinner" class="fa fa-spinner fa-spin ml-2 hidden"></i>
                        </button>
                    </div>
                </form>

                <!-- Results Section -->
                <div id="results" class="hidden mt-8">
                    <div class="prediction-card rounded-xl p-6 md:p-8 shadow-lg">
                        <h3 class="text-2xl font-bold text-white mb-4 text-center">Tax Prediction Result</h3>
                        <div class="text-center mb-4">
                            <p class="text-white text-lg mb-2">For Year: <span id="predictionYearDisplay" class="font-semibold">2025</span></p>
                            <p class="text-white text-sm">Based on your income trend analysis</p>
                        </div>
                        <div class="flex justify-center items-center mb-6">
                            <p id="predictedTax" class="text-5xl font-bold text-white">₹0</p>
                        </div>
                        
                        <!-- Save Prediction Section -->
                        {% if session.user_id %}
                        <div class="save-section bg-white bg-opacity-20 rounded-lg">
                            <p class="text-white text-sm mb-3 text-center">Save this prediction to your dashboard?</p>
                            <div class="flex justify-center space-x-3">
                                <button id="save-prediction-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center">
                                    <i class="fas fa-save mr-2"></i> Save Prediction
                                </button>
                            </div>
                            <div id="save-prediction-message" class="save-message" style="display:none"></div>
                        </div>
                        {% else %}
                        <div class="login-prompt bg-white bg-opacity-20 rounded-lg">
                            <a href="/login" class="text-blue-600 font-medium bg-white px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">Login</a> to save your predictions
                        </div>
                        {% endif %}
                    </div>

                    <!-- Additional Insights -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">Income Growth</h4>
                            <p id="incomeGrowth" class="text-blue-600 text-sm">Calculating...</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h4 class="font-semibold text-green-800 mb-2">Tax Efficiency</h4>
                            <p id="taxEfficiency" class="text-green-600 text-sm">Calculating...</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h4 class="font-semibold text-purple-800 mb-2">Prediction Confidence</h4>
                            <p class="text-purple-600 text-sm">Based on ML model</p>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 rounded-lg text-red-700 border border-red-200 text-center font-medium"></div>
            </div>
        </div>
    </div>

    <script>
        // Global utility function for showing save messages
        function showSaveMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            element.className = `save-message save-${type}`;
            
            // Hide message after 5 seconds
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const taxPredictForm = document.getElementById('taxPredictForm');
            const predictBtn = document.getElementById('predictBtn');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsDiv = document.getElementById('results');
            const predictedTaxDiv = document.getElementById('predictedTax');
            const predictionYearDisplay = document.getElementById('predictionYearDisplay');
            const incomeGrowthDiv = document.getElementById('incomeGrowth');
            const taxEfficiencyDiv = document.getElementById('taxEfficiency');
            const errorMessageDiv = document.getElementById('errorMessage');
            const savePredictionBtn = document.getElementById('save-prediction-btn');

            let currentPredictionData = null;

            taxPredictForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Show loading state
                predictBtn.disabled = true;
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                errorMessageDiv.classList.add('hidden');
                
                // Collect all form data
                const pastIncome1 = parseFloat(document.getElementById('past_income_year_1').value);
                const pastTax1 = parseFloat(document.getElementById('past_tax_year_1').value);
                const pastIncome2 = parseFloat(document.getElementById('past_income_year_2').value);
                const pastTax2 = parseFloat(document.getElementById('past_tax_year_2').value);
                const currentIncome = parseFloat(document.getElementById('current_income').value);
                const predictionYear = parseInt(document.getElementById('prediction_year').value);
                
                try {
                    const response = await fetch('/predict_tax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            past_income_year_1: pastIncome1,
                            past_tax_year_1: pastTax1,
                            past_income_year_2: pastIncome2,
                            past_tax_year_2: pastTax2,
                            current_income: currentIncome,
                            prediction_year: predictionYear
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Prediction failed.');
                    }

                    const data = await response.json();
                    const predictedTax = data.predicted_tax;

                    // Display results
                    predictedTaxDiv.textContent = `₹${predictedTax.toLocaleString('en-IN', {
                        maximumFractionDigits: 2
                    })}`;
                    predictionYearDisplay.textContent = predictionYear;
                    
                    // Calculate and display insights
                    const incomeGrowth = ((pastIncome2 - pastIncome1) / pastIncome1 * 100).toFixed(1);
                    const avgTaxRate1 = (pastTax1 / pastIncome1 * 100).toFixed(1);
                    const avgTaxRate2 = (pastTax2 / pastIncome2 * 100).toFixed(1);
                    
                    incomeGrowthDiv.textContent = `${incomeGrowth}% from previous year`;
                    taxEfficiencyDiv.textContent = `Avg rate: ${avgTaxRate2}% (was ${avgTaxRate1}%)`;
                    
                    resultsDiv.classList.remove('hidden');
                    
                    // Store prediction data for saving
                    currentPredictionData = {
                        past_income_year_1: pastIncome1,
                        past_tax_year_1: pastTax1,
                        past_income_year_2: pastIncome2,
                        past_tax_year_2: pastTax2,
                        current_income: currentIncome,
                        prediction_year: predictionYear,
                        predicted_tax: predictedTax,
                        income_growth: incomeGrowth,
                        tax_efficiency: avgTaxRate2
                    };
                    
                } catch (error) {
                    errorMessageDiv.textContent = `Error: ${error.message}`;
                    errorMessageDiv.classList.remove('hidden');
                } finally {
                    // Reset button state
                    predictBtn.disabled = false;
                    buttonText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                }
            });

            // Save Prediction functionality
            if (savePredictionBtn) {
                savePredictionBtn.addEventListener('click', async () => {
                    if (!currentPredictionData) {
                        showSaveMessage('save-prediction-message', 'Please make a prediction first', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/save_calculation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                type: 'tax_prediction',
                                input_data: {
                                    past_income_year_1: currentPredictionData.past_income_year_1,
                                    past_tax_year_1: currentPredictionData.past_tax_year_1,
                                    past_income_year_2: currentPredictionData.past_income_year_2,
                                    past_tax_year_2: currentPredictionData.past_tax_year_2,
                                    current_income: currentPredictionData.current_income,
                                    prediction_year: currentPredictionData.prediction_year
                                },
                                result: {
                                    predicted_tax: currentPredictionData.predicted_tax,
                                    income_growth: currentPredictionData.income_growth,
                                    tax_efficiency: currentPredictionData.tax_efficiency
                                }
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showSaveMessage('save-prediction-message', '✓ Tax prediction saved to your dashboard!', 'success');
                        } else {
                            showSaveMessage('save-prediction-message', '✗ Failed to save prediction', 'error');
                        }
                    } catch (error) {
                        showSaveMessage('save-prediction-message', '✗ Error saving prediction', 'error');
                    }
                });
            }

            // Auto-fill current year for prediction
            const currentYear = new Date().getFullYear() + 1;
            document.getElementById('prediction_year').value = currentYear;
        });
    </script>
</body>
</html>